name: Manual Test - Develop Image

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test (default: develop)'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - latest
          - master

jobs:
  test-develop-image:
    name: Test Develop Image
    runs-on: ubuntu-latest
    
    steps:
    #   - name: Login to Docker Hub
    #     uses: docker/login-action@v3
    #     with:
    #       username: ${{ secrets.DOCKER_USERNAME }}
    #       password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull and test AMD64 image
        run: |
          echo "üê≥ Pulling projectoss/eks-helm-client:develop (amd64)..."
          docker pull --platform linux/amd64 projectoss/eks-helm-client:develop
          
          echo "‚úÖ Image pulled successfully"
          docker images projectoss/eks-helm-client:develop

      - name: Test - All Tools
        run: |
          echo "üß™ Testing all tools..."
          
          docker run --rm projectoss/eks-helm-client:develop \
            /bin/bash -c '
              echo "=== Tool Versions ==="
              echo "kubectl: $(kubectl version --client --short 2>/dev/null | head -n1)"
              echo "Helm: $(helm version --short 2>/dev/null)"
              echo "AWS CLI: $(aws --version 2>/dev/null)"
              echo "aws-iam-authenticator: $(aws-iam-authenticator version 2>/dev/null | head -n1)"
              echo ""
              echo "=== Architecture ==="
              uname -m
              echo ""
              echo "=== User ==="
              whoami
              id
            '

      - name: Test - Non-Root User
        run: |
          echo "üîí Testing non-root user..."
          USER=$(docker run --rm projectoss/eks-helm-client:develop whoami)
          if [ "$USER" = "kubectl" ]; then
            echo "‚úÖ Running as non-root user: $USER"
          else
            echo "‚ùå Not running as kubectl user (got: $USER)"
            exit 1
          fi

      - name: Test - Permissions
        run: |
          echo "üìÅ Testing directory permissions..."
          docker run --rm projectoss/eks-helm-client:develop \
            /bin/bash -c '
              touch /opt/kubernetes/test.txt && rm /opt/kubernetes/test.txt && echo "‚úÖ /opt/kubernetes writable"
              touch /opt/helm/test.txt && rm /opt/helm/test.txt && echo "‚úÖ /opt/helm writable"
              touch ~/test.txt && rm ~/test.txt && echo "‚úÖ home directory writable"
            '

      - name: Test - Environment Validation
        run: |
          echo "üîß Testing environment validation..."
          if docker run --rm projectoss/eks-helm-client:develop \
            /entrypoint.sh echo "test" 2>&1 | grep -q "REGION_CODE"; then
            echo "‚úÖ Environment validation works"
          else
            echo "‚ùå Environment validation failed"
            exit 1
          fi

      - name: Test - Helm Functionality
        run: |
          echo "‚éà Testing Helm functionality..."
          docker run --rm projectoss/eks-helm-client:develop \
            /bin/bash -c '
              helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo list
              helm search repo bitnami/nginx
            '

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "=== Test Summary ==="
          echo "Image: projectoss/eks-helm-client:develop"
          echo "Status: ${{ job.status }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ All tests passed! The ${{ inputs.image_tag }} image is working correctly."
          else
            echo "‚ùå Some tests failed. Please check the logs above."
          fi

  integration-test-kind:
    name: Integration Test with Kind
    runs-on: ubuntu-latest
    needs: test-develop-image
    
    steps:
    #   - name: Login to Docker Hub
    #     uses: docker/login-action@v3
    #     with:
    #       username: ${{ secrets.DOCKER_USERNAME }}
    #       password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull image
        run: |
          docker pull projectoss/eks-helm-client:develop

      - name: Create Kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: test-cluster
          wait: 30s

      - name: Test with Kind
        run: |
          echo "üéØ Testing with Kind cluster..."
          
          # Get kubeconfig
          kind get kubeconfig --name test-cluster > /tmp/kind-config
          
          # Test kubectl
          echo "Testing kubectl get nodes..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            projectoss/eks-helm-client:develop \
            kubectl get nodes
          
          # Test kubectl cluster-info
          echo "Testing kubectl cluster-info..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            projectoss/eks-helm-client:develop \
            kubectl cluster-info
          
          # Test helm
          echo "Testing helm with cluster..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            projectoss/eks-helm-client:develop \
            helm list --all-namespaces

      - name: Deploy test application
        run: |
          echo "üöÄ Deploying test application..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            projectoss/eks-helm-client:develop \
            /bin/bash -c '
              helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo update
              helm install test-nginx bitnami/nginx \
                --set service.type=ClusterIP \
                --wait --timeout 3m
              
              echo "Deployment successful!"
              helm list
              kubectl get pods
              
              # Cleanup
              helm uninstall test-nginx
            '

      - name: Integration Test Summary
        if: always()
        run: |
          echo ""
          echo "=== Integration Test Summary ==="
          echo "Image: projectoss/eks-helm-client:develop"
          echo "Kind Version: $(kind version)"
          echo "Status: ${{ job.status }}"
          echo ""
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Integration tests passed! Image works with Kubernetes."
          fi

  final-summary:
    name: Final Test Report
    runs-on: ubuntu-latest
    needs: [test-develop-image, integration-test-kind]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "# üß™ Test Results for \`${{ inputs.image_tag }}\` image" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-develop-image.result }}" = "success" ]; then
            echo "| Basic Functionality | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Basic Functionality | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.integration-test-kind.result }}" = "success" ]; then
            echo "| Integration (Kind) | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Integration (Kind) | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`projectoss/eks-helm-client:develop\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-develop-image.result }}" = "success" ] && [ "${{ needs.integration-test-kind.result }}" = "success" ]; then
            echo "## ‚úÖ All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`${{ inputs.image_tag }}\` image is ready to use!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Print final status
        run: |
          echo "=== Final Test Report ==="
          echo "Image: projectoss/eks-helm-client:develop"
          echo "Basic Tests: ${{ needs.test-develop-image.result }}"
          echo "Integration Tests: ${{ needs.integration-test-kind.result }}"
          
          if [ "${{ needs.test-develop-image.result }}" = "success" ] && [ "${{ needs.integration-test-kind.result }}" = "success" ]; then
            echo ""
            echo "‚úÖ SUCCESS! All tests passed."
            exit 0
          else
            echo ""
            echo "‚ùå FAILED! Some tests did not pass."
            exit 1
          fi