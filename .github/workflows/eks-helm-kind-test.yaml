name: Test Docker Image

on:
  push:
    branches:
      - main
      - master
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  test:
    name: Test Image Build and Functionality
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract platform info
        id: platform
        run: |
          PLATFORM_PAIR=${{ matrix.platform }}
          echo "os=${PLATFORM_PAIR%/*}" >> $GITHUB_OUTPUT
          echo "arch=${PLATFORM_PAIR#*/}" >> $GITHUB_OUTPUT
          echo "safe_arch=$(echo ${PLATFORM_PAIR#*/} | tr '/' '-')" >> $GITHUB_OUTPUT

      - name: Build image for testing
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          load: true
          tags: eks-helm-client:test-${{ steps.platform.outputs.safe_arch }}
          cache-from: type=gha,scope=${{ steps.platform.outputs.safe_arch }}
          cache-to: type=gha,mode=max,scope=${{ steps.platform.outputs.safe_arch }}

      - name: Test - Container Starts
        run: |
          docker run --rm \
            -e REGION_CODE="test-region" \
            -e CLUSTER_NAME="test-cluster" \
            eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            /bin/bash -c "echo 'Container started successfully'"

      - name: Test - kubectl Version
        run: |
          echo "Testing kubectl..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            kubectl version --client

      - name: Test - Helm Version
        run: |
          echo "Testing Helm..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            helm version

      - name: Test - AWS CLI Version
        run: |
          echo "Testing AWS CLI..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            aws --version

      - name: Test - aws-iam-authenticator Version
        run: |
          echo "Testing aws-iam-authenticator..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            aws-iam-authenticator version

      - name: Test - Non-Root User
        run: |
          echo "Testing non-root user..."
          USER=$(docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} whoami)
          if [ "$USER" != "kubectl" ]; then
            echo "Error: Container not running as kubectl user (got: $USER)"
            exit 1
          fi
          echo "‚úì Running as kubectl user"

      - name: Test - User ID
        run: |
          echo "Testing user ID..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} id

      - name: Test - Directory Permissions
        run: |
          echo "Testing directory permissions..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} /bin/bash -c '
            touch /opt/kubernetes/test.txt && rm /opt/kubernetes/test.txt && echo "‚úì /opt/kubernetes writable" || exit 1
            touch /opt/helm/test.txt && rm /opt/helm/test.txt && echo "‚úì /opt/helm writable" || exit 1
            touch ~/test.txt && rm ~/test.txt && echo "‚úì home directory writable" || exit 1
          '

      - name: Test - Environment Variable Validation
        run: |
          echo "Testing environment variable validation..."
          # Should fail without REGION_CODE
          if docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            /entrypoint.sh echo "test" 2>&1 | grep -q "REGION_CODE"; then
            echo "‚úì REGION_CODE validation works"
          else
            echo "‚úó REGION_CODE validation failed"
            exit 1
          fi
          
          # Should fail without CLUSTER_NAME
          if docker run --rm -e REGION_CODE="test" \
            eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            /entrypoint.sh echo "test" 2>&1 | grep -q "CLUSTER_NAME"; then
            echo "‚úì CLUSTER_NAME validation works"
          else
            echo "‚úó CLUSTER_NAME validation failed"
            exit 1
          fi

      - name: Test - Helm Functionality
        run: |
          echo "Testing Helm functionality..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} /bin/bash -c '
            helm repo add stable https://charts.helm.sh/stable
            helm repo list
            helm search repo stable --max-col-width 0 | head -5
          '

      - name: Test - kubectl Functionality
        run: |
          echo "Testing kubectl functionality..."
          docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} \
            kubectl api-resources --dry-run=client > /dev/null && echo "‚úì kubectl api-resources works"

      - name: Test - Image Size
        run: |
          echo "Checking image size..."
          SIZE=$(docker images eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} --format "{{.Size}}")
          echo "Image size for ${{ matrix.platform }}: $SIZE"

      - name: Test - Architecture Verification
        run: |
          echo "Verifying architecture..."
          ARCH=$(docker run --rm eks-helm-client:test-${{ steps.platform.outputs.safe_arch }} uname -m)
          echo "Container architecture: $ARCH"
          
          case "${{ steps.platform.outputs.arch }}" in
            amd64)
              if [ "$ARCH" != "x86_64" ]; then
                echo "Error: Expected x86_64, got $ARCH"
                exit 1
              fi
              ;;
            arm64)
              if [ "$ARCH" != "aarch64" ]; then
                echo "Error: Expected aarch64, got $ARCH"
                exit 1
              fi
              ;;
          esac
          echo "‚úì Architecture matches: $ARCH"

      - name: Test Summary
        if: always()
        run: |
          echo "=== Test Summary for ${{ matrix.platform }} ==="
          echo "Platform: ${{ matrix.platform }}"
          echo "Status: ${{ job.status }}"

  integration-test:
    name: Integration Test with Kind
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: eks-helm-client:integration-test
          cache-from: type=gha,scope=amd64
          platforms: linux/amd64

      - name: Create Kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: test-cluster
          wait: 30s

      - name: Test with Kind cluster
        run: |
          echo "Getting kubeconfig from Kind..."
          kind get kubeconfig --name test-cluster > /tmp/kind-config
          
          echo "Testing kubectl with Kind cluster..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            eks-helm-client:integration-test \
            kubectl get nodes
          
          echo "Testing kubectl cluster-info..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            eks-helm-client:integration-test \
            kubectl cluster-info
          
          echo "Testing helm list..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            eks-helm-client:integration-test \
            helm list --all-namespaces

      - name: Test Helm deployment
        run: |
          echo "Testing Helm chart deployment..."
          docker run --rm \
            --network host \
            -v /tmp/kind-config:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            eks-helm-client:integration-test \
            /bin/bash -c '
              helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo update
              helm install test-nginx bitnami/nginx --set service.type=ClusterIP --wait
              helm list
              helm uninstall test-nginx
            '

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: eks-helm-client:scan
          cache-from: type=gha,scope=amd64
          platforms: linux/amd64

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: eks-helm-client:scan
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy - SARIF report
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: eks-helm-client:scan
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: [test, integration-test, security-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build final image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: eks-helm-client:info
          platforms: linux/amd64

      - name: Display build information
        run: |
          echo "=== Build Information ==="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "=== Tool Versions ==="
          docker run --rm eks-helm-client:info /bin/bash -c '
            echo "kubectl: $(kubectl version --client --short 2>/dev/null | head -n1)"
            echo "Helm: $(helm version --short 2>/dev/null)"
            echo "AWS CLI: $(aws --version 2>/dev/null)"
            echo "aws-iam-authenticator: $(aws-iam-authenticator version 2>/dev/null | head -n1)"
          '
          echo ""
          echo "=== Image Details ==="
          docker images eks-helm-client:info --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
          echo ""
          echo "=== Test Status ==="
          echo "Unit Tests: ${{ needs.test.result }}"
          echo "Integration Tests: ${{ needs.integration-test.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testStatus = '${{ needs.test.result }}';
            const integrationStatus = '${{ needs.integration-test.result }}';
            const securityStatus = '${{ needs.security-scan.result }}';
            
            const statusEmoji = {
              'success': '‚úÖ',
              'failure': '‚ùå',
              'cancelled': '‚ö†Ô∏è',
              'skipped': '‚è≠Ô∏è'
            };
            
            const comment = `## üß™ Test Results
            
            | Test Type | Status |
            |-----------|--------|
            | Unit Tests (Multi-arch) | ${statusEmoji[testStatus]} ${testStatus} |
            | Integration Tests (Kind) | ${statusEmoji[integrationStatus]} ${integrationStatus} |
            | Security Scan | ${statusEmoji[securityStatus]} ${securityStatus} |
            
            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`
            
            <details>
            <summary>View Details</summary>
            
            - Tested on platforms: \`linux/amd64\`, \`linux/arm64\`
            - Integration tested with Kind (Kubernetes in Docker)
            - Security scanned with Trivy
            
            [View full test logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });