name: Quick Test

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
  workflow_dispatch:

jobs:
  quick-test:
    name: Quick Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: eks-helm-client:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test all tools
        run: |
          echo "üß™ Testing all tools..."
          
          # Test kubectl
          echo "Testing kubectl..."
          docker run --rm eks-helm-client:test kubectl version --client
          
          # Test Helm
          echo "Testing Helm..."
          docker run --rm eks-helm-client:test helm version
          
          # Test AWS CLI
          echo "Testing AWS CLI..."
          docker run --rm eks-helm-client:test aws --version
          
          # Test aws-iam-authenticator
          echo "Testing aws-iam-authenticator..."
          docker run --rm eks-helm-client:test aws-iam-authenticator version
          
          echo "‚úÖ All tools working!"

      - name: Test non-root user
        run: |
          USER=$(docker run --rm eks-helm-client:test whoami)
          if [ "$USER" = "kubectl" ]; then
            echo "‚úÖ Running as non-root user: $USER"
          else
            echo "‚ùå Not running as kubectl user"
            exit 1
          fi

      - name: Test environment validation
        run: |
          echo "Testing environment validation..."
          if docker run --rm eks-helm-client:test /entrypoint.sh echo "test" 2>&1 | grep -q "REGION_CODE"; then
            echo "‚úÖ Environment validation works"
          else
            echo "‚ùå Environment validation failed"
            exit 1
          fi

      - name: Show image info
        run: |
          echo "üì¶ Image information:"
          docker images eks-helm-client:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"