name: Test Develop Image in Kubernetes

on:
  # Trigger manually from Actions tab
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - latest
          - master
  
  # Trigger automatically when pushing to develop
  push:
    branches:
      - develop
      - main
      - master
  
  # Trigger on pull requests to develop
  pull_request:
    branches:
      - develop

jobs:
  test-kubernetes:
    name: Test in Kubernetes Cluster
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Determine which image tag to test
      - name: Determine image tag
        id: image_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="develop"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ³ Testing image: ${{ secrets.DOCKER_REPO }}/eks-helm-client:$TAG"

      # Step 2: Pull the published image (public image, no login needed)
      - name: Pull Docker image from Docker Hub
        run: |
          echo "ðŸ“¥ Pulling image from Docker Hub..."
          docker pull ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }}
          docker images | grep eks-helm-client
          echo "âœ… Image pulled successfully"

      # Step 3: Create Kind Kubernetes cluster
      - name: Create Kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: test-cluster
          wait: 30s
          node_image: kindest/node:v1.28.0

      # Step 4: Get kubeconfig
      - name: Get kubeconfig from Kind
        run: |
          echo "ðŸ“‹ Getting kubeconfig..."
          kind get kubeconfig --name test-cluster > /tmp/kubeconfig
          chmod 644 /tmp/kubeconfig
          echo "âœ… Kubeconfig ready"

      # Step 6: Test kubectl version
      - name: Test kubectl version
        run: |
          echo "ðŸ§ª Testing kubectl version..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            kubectl version --client

      # Step 7: Test kubectl cluster-info
      - name: Test kubectl cluster-info
        run: |
          echo "ðŸ§ª Testing kubectl cluster-info..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            kubectl cluster-info

      # Step 8: Test kubectl get nodes
      - name: Test kubectl get nodes
        run: |
          echo "ðŸ§ª Testing kubectl get nodes..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            kubectl get nodes -o wide

      # Step 9: Test kubectl get all resources
      - name: Test kubectl get all resources
        run: |
          echo "ðŸ§ª Testing kubectl get all resources..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            kubectl get all --all-namespaces

      # Step 10: Create test namespace
      - name: Create test namespace
        run: |
          echo "ðŸ§ª Creating test namespace..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            kubectl create namespace test-namespace
          
          echo "âœ… Namespace created"

      # Step 11: Test Helm version
      - name: Test Helm version
        run: |
          echo "ðŸ§ª Testing Helm version..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            helm version

      # Step 12: Add Helm repositories
      - name: Add Helm repositories
        run: |
          echo "ðŸ§ª Adding Helm repositories..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo add stable https://charts.helm.sh/stable
              helm repo update
              helm repo list
            '

      # Step 13: Search Helm charts
      - name: Search Helm charts
        run: |
          echo "ðŸ§ª Searching Helm charts..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            helm search repo bitnami/nginx

      # Step 14: Deploy application with Helm
      - name: Deploy nginx with Helm
        run: |
          echo "ðŸš€ Deploying nginx with Helm..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              helm install test-nginx bitnami/nginx \
                --namespace test-namespace \
                --set service.type=ClusterIP \
                --set replicaCount=1 \
                --wait --timeout 3m
            '
          
          echo "âœ… Deployment successful!"

      # Step 15: Verify deployment
      - name: Verify deployment
        run: |
          echo "âœ… Verifying deployment..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              echo "=== Pods ==="
              kubectl get pods -n test-namespace
              echo ""
              echo "=== Services ==="
              kubectl get services -n test-namespace
              echo ""
              echo "=== Helm Releases ==="
              helm list -n test-namespace
              echo ""
              echo "=== Deployments ==="
              kubectl get deployments -n test-namespace
            '

      # Step 16: Test Helm upgrade
      - name: Test Helm upgrade
        run: |
          echo "ðŸ”„ Testing Helm upgrade..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              helm upgrade test-nginx bitnami/nginx \
                --namespace test-namespace \
                --set replicaCount=2 \
                --wait --timeout 2m
              
              echo ""
              echo "After upgrade:"
              kubectl get pods -n test-namespace
            '

      # Step 17: Test kubectl describe
      - name: Test kubectl describe pod
        run: |
          echo "ðŸ” Testing kubectl describe..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              POD_NAME=$(kubectl get pods -n test-namespace -o jsonpath="{.items[0].metadata.name}")
              echo "Describing pod: $POD_NAME"
              kubectl describe pod $POD_NAME -n test-namespace
            '

      # Step 18: Test kubectl logs
      - name: Test kubectl logs
        run: |
          echo "ðŸ“‹ Testing kubectl logs..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              POD_NAME=$(kubectl get pods -n test-namespace -o jsonpath="{.items[0].metadata.name}")
              echo "Getting logs from pod: $POD_NAME"
              kubectl logs $POD_NAME -n test-namespace --tail=20
            '

      # Step 19: Test ConfigMap and Secret
      - name: Test ConfigMap and Secret
        run: |
          echo "ðŸ§ª Testing ConfigMap and Secret..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              kubectl create configmap test-config --from-literal=key1=value1 -n test-namespace
              kubectl create secret generic test-secret --from-literal=password=secret123 -n test-namespace
              
              echo "ConfigMaps:"
              kubectl get configmaps -n test-namespace
              
              echo ""
              echo "Secrets:"
              kubectl get secrets -n test-namespace
            '

      # Step 20: Cleanup
      - name: Cleanup resources
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          docker run --rm \
            --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }} \
            /bin/bash -c '
              helm uninstall test-nginx -n test-namespace || true
              kubectl delete namespace test-namespace || true
              kubectl delete configmap test-config || true
              kubectl delete secret test-secret || true
            ' || true
          
          echo "âœ… Cleanup complete"

      # Step 21: Test Summary
      - name: Display test summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "       TEST SUMMARY"
          echo "======================================"
          echo "Image: ${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }}"
          echo "Status: ${{ job.status }}"
          echo "======================================"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ALL TESTS PASSED!"
            echo ""
            echo "Tests completed:"
            echo "  âœ… kubectl version"
            echo "  âœ… kubectl cluster-info"
            echo "  âœ… kubectl get nodes"
            echo "  âœ… kubectl get resources"
            echo "  âœ… Namespace creation"
            echo "  âœ… Helm version"
            echo "  âœ… Helm repository management"
            echo "  âœ… Helm chart search"
            echo "  âœ… Helm deployment"
            echo "  âœ… Helm upgrade"
            echo "  âœ… kubectl describe"
            echo "  âœ… kubectl logs"
            echo "  âœ… ConfigMap and Secret"
            echo ""
            echo "Your image is ready for production! ðŸš€"
          else
            echo "âŒ SOME TESTS FAILED"
            echo "Please check the logs above for details."
          fi

      # Step 22: Create GitHub Summary
      - name: Create test summary for GitHub
        if: always()
        run: |
          echo "# ðŸ§ª Kubernetes Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ secrets.DOCKER_REPO }}/eks-helm-client:${{ steps.image_tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** Kind (Kubernetes in Docker)" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Tests Completed:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Category | Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | version | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | cluster-info | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | get nodes | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | get all resources | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | create namespace | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | describe pod | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl | logs | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm | version | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm | repository management | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm | chart search | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm | deployment | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm | upgrade | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Resources | ConfigMap | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Resources | Secret | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸš€ Your image is production-ready!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY