name: Test Develop Image in Kubernetes

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - latest
         
  push:
    branches:
      - develop
      - main
      
    paths: 
        - '.github/workflows/test.yaml'
  pull_request:
    branches:
      - develop

jobs:
  test-kubernetes:
    name: Test in Kubernetes Cluster
    runs-on: ubuntu-latest
    
    steps:
      - name: Pull Docker image
        run: |
          echo "ðŸ“¥ Pulling public image..."
          docker pull projectoss/eks-helm-client:develop-26470ef
          echo "âœ… Image pulled"

      - name: Create Kind cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: test-cluster
          wait: 30s

      - name: Get kubeconfig
        run: |
          kind get kubeconfig --name test-cluster > /tmp/kubeconfig
          chmod 644 /tmp/kubeconfig

      - name: Test kubectl version
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint kubectl \
            projectoss/eks-helm-client:develop-26470ef \
            version --client

      - name: Test kubectl cluster-info
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint kubectl \
            projectoss/eks-helm-client:develop-26470ef \
            cluster-info

      - name: Test kubectl get nodes
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint kubectl \
            projectoss/eks-helm-client:develop-26470ef \
            get nodes -o wide

      - name: Create namespace
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint kubectl \
            projectoss/eks-helm-client:develop-26470ef \
            create namespace test-ns

      - name: Test Helm version
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint helm \
            projectoss/eks-helm-client:develop-26470ef \
            version

      - name: Add Helm repos and deploy
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint /bin/bash \
            projectoss/eks-helm-client:develop-26470ef \
            -c '
              helm repo add bitnami https://charts.bitnami.com/bitnami
              helm repo update
              helm install nginx bitnami/nginx --namespace test-ns --set service.type=ClusterIP --wait --timeout 3m
            '

      - name: Verify deployment
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint /bin/bash \
            projectoss/eks-helm-client:develop-26470ef \
            -c '
              echo "=== Pods ==="
              kubectl get pods -n test-ns
              echo ""
              echo "=== Services ==="
              kubectl get services -n test-ns
              echo ""
              echo "=== Helm Releases ==="
              helm list -n test-ns
            '

      - name: Test Helm upgrade
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint /bin/bash \
            projectoss/eks-helm-client:develop-26470ef \
            -c '
              helm upgrade nginx bitnami/nginx --namespace test-ns --set replicaCount=2 --wait --timeout 2m
              kubectl get pods -n test-ns
            '

      - name: Test kubectl logs
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint /bin/bash \
            projectoss/eks-helm-client:develop-26470ef \
            -c '
              POD=$(kubectl get pods -n test-ns -o jsonpath="{.items[0].metadata.name}")
              kubectl logs $POD -n test-ns --tail=10
            '

      - name: Cleanup
        if: always()
        run: |
          docker run --rm --network host \
            -v /tmp/kubeconfig:/opt/kubernetes/config:ro \
            -e KUBECONFIG=/opt/kubernetes/config \
            --entrypoint /bin/bash \
            projectoss/eks-helm-client:develop-26470ef \
            -c '
              helm uninstall nginx -n test-ns || true
              kubectl delete namespace test-ns || true
            ' || true

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "======================================"
          echo "       TEST SUMMARY"
          echo "======================================"
          echo "Image: projectoss/eks-helm-client:develop-26470ef"
          echo "Status: ${{ job.status }}"
          echo "======================================"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo ""
            echo "âœ… ALL TESTS PASSED!"
            echo ""
            echo "Tests completed:"
            echo "  âœ… kubectl version & cluster-info"
            echo "  âœ… kubectl get nodes & resources"
            echo "  âœ… Namespace creation"
            echo "  âœ… Helm version"
            echo "  âœ… Helm deployment"
            echo "  âœ… Helm upgrade"
            echo "  âœ… kubectl logs"
            echo ""
            echo "Your image is production-ready! ðŸš€"
          fi

      - name: GitHub Summary
        if: always()
        run: |
          echo "# Kubernetes Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`projectoss/eks-helm-client:develop-26470ef\`" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** Kind (Kubernetes in Docker)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… All Tests Passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl version | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl cluster-info | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl get nodes | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Namespace creation | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm version | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm deployment | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Helm upgrade | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| kubectl logs | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸš€ Image is production-ready!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi